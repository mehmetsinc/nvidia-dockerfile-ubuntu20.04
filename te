# FROM nvidia/cudagl:11.0-devel-ubuntu20.04
FROM nvidia/cuda:11.3.1-cudnn8-devel-ubuntu20.04

# Set the working directory
WORKDIR /root

ENV TZ=Asia/Kolkata \
    DEBIAN_FRONTEND=noninteractive

RUN apt-get update && \
    apt-get install tzdata
# Update and install required packages
RUN apt-get update && apt-get install -y --no-install-recommends \
	ca-certificates \
	wget \
    ubuntu-desktop \
    gnome-panel \
    gnome-settings-daemon \
    xfce4-panel \
    xfce4-settings \
    xfwm4 \
    xfdesktop4 \
    tightvncserver \
    nano \
    python3-pip \
    && rm -rf /var/lib/apt/lists/*

# GPG key
# RUN   apt-key del 7fa2af80
# ADD   https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2004/x86_64/cuda-keyring_1.0-1_all.deb .
# RUN   dpkg -i cuda-keyring_1.0-1_all.deb

# RUN   apt-get update

########
# RUN apt-key del 7fa2af80 \
# 	curl -L -O https://developer.download.nvidia.com/compute/cuda/repos/ubuntu1804/x86_64/cuda-keyring_1.0-1_all.deb \
#     dpkg -i cuda-keyring_1.0-1_all.deb \
##########
# RUN apt-get install -y --no-install-recommends wget
# RUN apt-key del 7fa2af80
# RUN wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2004/x86_64/cuda-keyring_1.0-1_all.deb
# RUN dpkg -i cuda-keyring_1.0-1_all.deb
# RUN apt-get update

# RUN wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2004/x86_64/cuda-ubuntu2004.pin
# RUN sudo mv cuda-ubuntu2004.pin /etc/apt/preferences.d/cuda-repository-pin-600
# RUN sudo apt-key adv --fetch-keys https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2004/x86_64/3bf863cc.pub
# RUN sudo add-apt-repository "deb https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2004/x86_64/ /"
# RUN sudo apt-get update
# RUN sudo apt-get -y install cuda

#########
# RUN rm /etc/apt/sources.list.d/cuda.list
# RUN rm /etc/apt/sources.list.d/nvidia-ml.list
# RUN apt-key del 7fa2af80
# RUN apt-get update && apt-get install -y --no-install-recommends wget
# RUN wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu1804/x86_64/cuda-keyring_1.0-1_all.deb
# RUN dpkg -i cuda-keyring_1.0-1_all.deb
#######
# RUN rm /etc/apt/sources.list.d/cuda.list && \ apt-key del 7fa2af80 && \ apt-key adv --fetch-keys https://developer.download.nvidia.com/compute/cuda/repos/ubuntu1804/x86_64/3bf863cc.pub
RUN apt-key adv --fetch-keys https://developer.download.nvidia.cn/compute/cuda/repos/ubuntu2004/x86_64/3bf863cc.pub
#######
# RUN \
#     # Update nvidia GPG key
#     rm /etc/apt/sources.list.d/cuda.list && \
#     rm /etc/apt/sources.list.d/nvidia-ml.list && \
#     apt-key del 7fa2af80 && \
#     apt-get update && apt-get install -y --no-install-recommends wget && \
#     wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2004/x86_64/cuda-keyring_1.0-1_all.deb && \
#     dpkg -i cuda-keyring_1.0-1_all.deb && \
#     apt-get update

# Install xrdp
RUN apt-get update && apt-get install -y xrdp

# Create user and set password
RUN useradd -m -d /home/ubuntu -s /bin/bash ubuntu \
    && echo "ubuntu:password" | chpasswd

# Add user to sudoers
RUN echo "ubuntu ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# Allow remote connection
RUN echo "gnome-session --session=xfce" >> /etc/xrdp/startwm.sh

# Allow remote connection
RUN echo "gnome-session --session=xfce" >> /etc/xrdp/startwm.sh

# Create shared folder
# RUN mkdir /home/shared
# RUN chmod -R 755 /home/shared
# RUN chown -R ubuntu:ubuntu /home/shared

# Copy python script for GPU information
COPY gpu-info.py /Users/mehmet.sinc/vs_code/oleks/gpu-info.py

# Expose ports for remote desktop and ssh
# EXPOSE 22
EXPOSE 3389
EXPOSE 6080

# Run the command on container startup
CMD ["/usr/sbin/xrdp", "-nodaemon"]
